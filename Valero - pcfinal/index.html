<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Ecosistema AR/VR - Mono Animado</title>

    <!-- A-FRAME -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase.js"></script>

    <style>
      body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
      #info {
        position: absolute;
        left: 12px;
        top: 12px;
        background: rgba(0,0,0,0.6);
        color: white;
        padding: 8px 10px;
        border-radius: 6px;
        z-index: 10;
        font-size: 14px;
      }
      #startAudio {
        background: #1e88e5;
        border: none;
        color: white;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div id="info">
      <strong>Ecosistema AR/VR</strong>
      <div style="margin-top:6px;">
        <button id="startAudio">Tocar audio (click una vez)</button>
        <span style="margin-left:8px; font-size:12px; opacity:0.9;">(desbloquea sonido)</span>
      </div>
    </div>

    <a-scene background="color: #87CEEB">
      <!-- Cielo -->
      <a-sky id="cielo" color="#87CEEB"></a-sky>

      <!-- Suelo -->
      <a-plane position="0 0 -5" rotation="-90 0 0"
               width="20" height="20" color="#7FB77E"></a-plane>

      <!-- Río (superpuesto sobre suelo, un poco más cerca) -->
      <a-plane position="0 0 -4.9" rotation="-90 0 0"
               width="10" height="3" color="#1E88E5" opacity="0.8"></a-plane>

      <!-- Árboles con movimiento suave -->
      <a-entity id="arboles">
        <a-cylinder position="-3 0 -6" height="3" radius="0.3" color="#6D4C41"></a-cylinder>
        <a-sphere class="hojas" position="-3 2 -6" radius="1.5" color="#2E7D32"
                  animation="property: rotation; to: 0 5 0; dur: 4000; dir: alternate; loop: true; easing: linear">
        </a-sphere>

        <a-cylinder position="3 0 -7" height="3" radius="0.3" color="#6D4C41"></a-cylinder>
        <a-sphere class="hojas" position="3 2 -7" radius="1.5" color="#2E7D32"
                  animation="property: rotation; to: 0 -5 0; dur: 4200; dir: alternate; loop: true; easing: linear">
        </a-sphere>
      </a-entity>

      <!-- ANIMAL: mono con animaciones -->
      <a-entity id="animal" position="0 1 -2" scale="1 1 1"
                animation="property: position; to: 0 1.05 -2; dir: alternate; dur: 1200; loop: true; easing: easeInOutSine">

        <!-- cuerpo y cabeza -->
        <a-sphere id="cuerpo" position="0 0 0" radius="0.4" color="#8B4513"></a-sphere>
        <a-sphere id="cabeza" position="0 0.5 0.2" radius="0.28" color="#A97458"
                  animation__cabeza="property: rotation; to: 0 8 0; dir: alternate; dur: 2000; loop: true;">
        </a-sphere>

        <!-- orejas -->
        <a-sphere id="oreja1" position="-0.25 0.55 0.1" radius="0.12" color="#A97458"></a-sphere>
        <a-sphere id="oreja2" position="0.25 0.55 0.1" radius="0.12" color="#A97458"></a-sphere>

        <!-- hocico -->
        <a-sphere id="hocico" position="0 0.45 0.35" radius="0.15" color="#E0B38A"></a-sphere>

        <!-- ojos (haremos parpadeo con JS) -->
        <a-sphere id="ojo1" position="-0.08 0.55 0.42" radius="0.05" color="white"></a-sphere>
        <a-sphere id="ojo2" position="0.08 0.55 0.42" radius="0.05" color="white"></a-sphere>

        <a-sphere id="pup1" position="-0.08 0.55 0.47" radius="0.02" color="black"></a-sphere>
        <a-sphere id="pup2" position="0.08 0.55 0.47" radius="0.02" color="black"></a-sphere>

        <!-- Brazos animados -->
        <a-cylinder id="brazo1" position="-0.5 -0.1 0"
                    height="0.4" radius="0.08" rotation="0 0 20" color="#6D4C41"
                    animation__brazo1="property: rotation; to: 0 0 40; dir: alternate; loop: true; dur: 800; easing: easeInOutSine">
        </a-cylinder>

        <a-cylinder id="brazo2" position="0.5 -0.1 0"
                    height="0.4" radius="0.08" rotation="0 0 -20" color="#6D4C41"
                    animation__brazo2="property: rotation; to: 0 0 -40; dir: alternate; loop: true; dur: 800; easing: easeInOutSine">
        </a-cylinder>

        <!-- Piernas -->
        <a-cylinder id="pierna1" position="-0.15 -0.6 0"
                    height="0.5" radius="0.08" color="#6D4C41"></a-cylinder>

        <a-cylinder id="pierna2" position="0.15 -0.6 0"
                    height="0.5" radius="0.08" color="#6D4C41"></a-cylinder>

      </a-entity>

     <!-- PANEL (información) -->
<a-entity position="3.2 3 -3">

  <!-- Fondo del panel -->
  <a-plane width="3" height="2" color="#222" opacity="0.9"></a-plane>

  <!-- TEXTO 1 - Temperatura -->
  <a-text id="temp-text"
          value="Temp: --"
          position="-1.3 0.6 0.01"
          color="white"
          align="left"
          scale="1 1 1">
  </a-text>

  <!-- TEXTO 2 - Humedad -->
  <a-text id="hum-text"
          value="Humedad: --"
          position="-1.3 0.2 0.01"
          color="white"
          align="left"
          scale="1 1 1">
  </a-text>

  <!-- TEXTO 3 - Ritmo cardíaco -->
  <a-text id="ritmo-text"
          value="Ritmo: --"
          position="-1.3 -0.2 0.01"
          color="white"
          align="left"
          scale="1 1 1">
  </a-text>

  <!-- TEXTO 4 - Estado -->
  <a-text id="estado-text"
          value="Estado: --"
          position="-1.3 -0.6 0.01"
          color="white"
          align="left"
          scale="1 1 1">
  </a-text>

</a-entity>


      <!-- ALERTA (anillo parpadeante) -->
      <a-ring id="alerta" position="0 3 -4"
              radius-inner="0.5" radius-outer="0.7"
              color="red" visible="false"
              animation__alerta="property: scale; to: 1.3 1.3 1.3; dir: alternate; dur: 500; loop: true">
      </a-ring>

      <!-- SONIDO: mono enojado -->
      <a-entity id="audio-holder" position="0 1 -2">
        <a-sound id="sonidoStress"
                 src="url(sonidos/mono_enojado.mp3)"
                 autoplay="false"
                 positional="true"
                 distanceModel="linear"
                 maxDistance="10"
                 refDistance="1">
        </a-sound>
      </a-entity>

      <!-- MINI MAPA -->
      <a-plane id="mapa" position="-3 2 -3"
               width="1.5" height="1.5"
               color="green" opacity="0.8"></a-plane>

      <!-- Cámara -->
      <a-entity position="0 0.2 0">
        <a-camera></a-camera>
      </a-entity>

    </a-scene>

    <!-- SCRIPT -->
    <script>
      /* ===============================
          FIREBASE CONFIG (mantener tu config)
      ================================ */
      firebase.initializeApp({
        apiKey: "AIzaSyAEyHpWbk71bSkHjC4F2vAmzsi7zADsu00",
        databaseURL: "https://realpc4-691a4-default-rtdb.firebaseio.com"
      });

      // Colores originales (para restaurar)
      const coloresOriginales = {
        cuerpo: "#8B4513",
        cabeza: "#A97458",
        oreja1: "#A97458",
        oreja2: "#A97458",
        hocico: "#E0B38A",
        brazo1: "#6D4C41",
        brazo2: "#6D4C41",
        pierna1: "#6D4C41",
        pierna2: "#6D4C41"
      };
      const partesMono = Object.keys(coloresOriginales);

      function pintarMono(color) {
        partesMono.forEach(p => {
          const el = document.getElementById(p);
          if (el) el.setAttribute("color", color);
        });
      }
      function restaurarMono() {
        partesMono.forEach(p => {
          const el = document.getElementById(p);
          if (el) el.setAttribute("color", coloresOriginales[p]);
        });
      }

      // Variables
      let alertaActiva = false;
      let sonidoDesbloqueado = false;
      let parpadeoInterval = null;
      let ojo1 = null;
      let ojo2 = null;
      let pup1 = null;
      let pup2 = null;

      // Obtener referencias rápidas
      const animal = document.getElementById('animal');
      const sonido = document.getElementById('sonidoStress');
      const alerta = document.getElementById('alerta');

      // Desbloquear audio con interacción del usuario:
      document.getElementById('startAudio').addEventListener('click', async () => {
        // intentar reanudar contextos de audio
        try {
          // crear/reanudar AudioContext para desbloquear audio en algunos navegadores
          const AudioContextClass = window.AudioContext || window.webkitAudioContext;
          if (AudioContextClass) {
            const ctx = new AudioContextClass();
            if (ctx.state === 'suspended') await ctx.resume();
          }
        } catch (e) {
          console.warn("No se pudo crear/reanudar AudioContext", e);
        }

        // trataremos de forzar a A-Frame a cargar/activar el componente de sonido
        if (sonido && sonido.components && sonido.components.sound) {
          // reproducir y detener inmediatamente para "desbloquear" el audio
          try {
            sonido.components.sound.playSound();
            setTimeout(() => {
              if (sonido.components && sonido.components.sound) sonido.components.sound.stopSound();
            }, 120);
            sonidoDesbloqueado = true;
            document.getElementById('startAudio').innerText = "Audio listo ✅";
            document.getElementById('startAudio').disabled = true;
          } catch (err) {
            console.warn("Error al desbloquear audio", err);
          }
        } else {
          // si aun no existe componente sound, marcar como desbloqueado igual (al interactuar)
          sonidoDesbloqueado = true;
          document.getElementById('startAudio').innerText = "Audio listo ✅";
          document.getElementById('startAudio').disabled = true;
        }
      });

      /* ===============================
         Parpadeo de ojos (JS - más realista)
      ================================ */
      function iniciarParpadeo() {
        ojo1 = document.getElementById('ojo1');
        ojo2 = document.getElementById('ojo2');
        pup1 = document.getElementById('pup1');
        pup2 = document.getElementById('pup2');

        if (!ojo1 || !ojo2) return;

        // limpiar si ya había
        if (parpadeoInterval) clearInterval(parpadeoInterval);

        // parpadeo aleatorio cada 2-6s
        parpadeoInterval = setInterval(() => {
          // cerrar (escalar en Y)
          ojo1.setAttribute('animation__blinkclose', 'property: scale; to: 1 0.05 1; dur: 120; easing: easeInOutQuad');
          ojo2.setAttribute('animation__blinkclose', 'property: scale; to: 1 0.05 1; dur: 120; easing: easeInOutQuad');

          // esconder pupilas mientras se cierra
          pup1.setAttribute('visible', 'false');
          pup2.setAttribute('visible', 'false');

          setTimeout(() => {
            // abrir
            ojo1.setAttribute('animation__blinkopen', 'property: scale; to: 1 1 1; dur: 120; easing: easeInOutQuad');
            ojo2.setAttribute('animation__blinkopen', 'property: scale; to: 1 1 1; dur: 120; easing: easeInOutQuad');
            pup1.setAttribute('visible', 'true');
            pup2.setAttribute('visible', 'true');
          }, 150);
        }, 2000 + Math.random() * 4000);
      }

      // iniciar parpadeo después de que DOM cargue
      window.addEventListener('load', () => {
        iniciarParpadeo();
      });

      /* ===============================
         Funciones extra: vibrar mono (estrés)
      ================================ */
      function activarVibracionMono(on) {
        if (on) {
          // agregar una animación corta de shake al animal
          animal.setAttribute('animation__shake', 'property: position; to: 0.03 1.05 -2; dir: alternate; dur: 80; loop: true; easing: linear');
        } else {
          // quitar la animación
          animal.removeAttribute('animation__shake');
          // restaurar posición por si acaso
          animal.setAttribute('position', '0 1 -2');
        }
      }

      /* ===============================
         Lectura del ÚLTIMO evento de Firebase
      ================================ */
      firebase.database().ref("eventos")
        .orderByKey()
        .limitToLast(1)
        .on("value", snap => {

          if (!snap.exists()) return;

          // obtener la clave del último evento
          const key = Object.keys(snap.val())[0];
          const data = snap.val()[key];

          console.log("Último evento recibido:", data);

          /* ====== PANEL ====== */
          document.getElementById("temp-text")
            .setAttribute("value", "Temp: " + data.sensores.temperatura);

          document.getElementById("hum-text")
            .setAttribute("value", "Humedad: " + data.sensores.humedad);

          document.getElementById("ritmo-text")
            .setAttribute("value", "Ritmo: " + data.sensores.ritmo);

          /* ====== ESTADO ====== */
          let ritmo = data.sensores.ritmo;
          let estado = "Normal";

          if (ritmo > 150) estado = "Estres Alto";
          else if (ritmo > 110) estado = "Alerta";

          document.getElementById("estado-text")
            .setAttribute("value", "Estado: " + estado);

          /* ====== MINI MAPA ====== */
          const colorMapa =
            ritmo > 150 ? "red" :
            ritmo > 110 ? "yellow" :
            "green";

          document.getElementById("mapa").setAttribute("color", colorMapa);

          /* ====== ALERTA ====== */
          const peligro = !!data.alerta && !!data.alerta.peligro;

          alerta.setAttribute("visible", peligro);

          if (peligro) {
            pintarMono("red");
          } else {
            restaurarMono();
          }

          /* ====== HUMEDAD → ÁRBOLES ====== */
          const hum = data.sensores.humedad;
          const colorHojas = hum < 30 ? "#8B4513" : "#2E7D32";

          document.querySelectorAll(".hojas").forEach(h => {
            h.setAttribute("color", colorHojas);
          });

          /* ====== SONIDO SEGÚN ESTADO ====== */
          // Asegurarse que componente sound esté listo
          setTimeout(() => {
            try {
              // obtener componente sound si existe
              const sonidoComp = sonido && sonido.components && sonido.components.sound;
              if (estado === "Estres Alto") {
                // activar vibración visual y reproducir sonido si audio fue desbloqueado por el usuario
                activarVibracionMono(true);

                if (sonidoComp) {
                  // si no se desbloqueó por el botón, intentar reproducir de todas formas (navegadores bloquearán si no hubo interacción)
                  sonidoComp.playSound();
                }
              } else {
                // detener sonido y vibración
                activarVibracionMono(false);
                if (sonidoComp) sonidoComp.stopSound();
              }
            } catch (e) {
              console.warn("Error controlando audio", e);
            }
          }, 50);

        });

      /* ===============================
         Movimiento "en sitio" extra para la cabeza/torso (pequeña oscilación aleatoria)
      ================================ */
      (function movimientoEnSitio() {
        // cada 1s ajusta ligera rotación/posición para dar vida
        setInterval(() => {
          const rx = (Math.random() - 0.5) * 4; // rotación leve
          const ry = (Math.random() - 0.5) * 6;
          const tx = (Math.random() - 0.5) * 0.02;
          const ty = (Math.random() - 0.5) * 0.02;
          const tz = (Math.random() - 0.5) * 0.02;

          // aplicar suavemente usando animation attributes temporales
          animal.setAttribute('animation__tinypos', `property: position; to: ${tx} ${1+ty} ${-2+tz}; dur: 700; easing: easeInOutSine`);
          animal.setAttribute('animation__tinyrot', `property: rotation; to: ${rx} ${ry} 0; dur: 900; easing: easeInOutSine`);
        }, 1000);
      })();

    </script>
  </body>
</html>
